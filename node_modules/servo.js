var fs = require('fs');
var path = require('path');
var basePath = (process.env.TEST ? path.join(__dirname, 'test-pwm0') : '/sys/class/rpi-pwm/pwm0/');
var servoStream;

function set(name, value) {
	value = value + '';
	fs.writeFileSync(path.join(basePath, name), value, { encoding: 'ascii' });
}


function writeFile (data) {

fs.writeFile(path.join(basePath,'servo'),data, function(err) {
            if(err) {
                console.log(err);
          } else {
                console.log("Motor at :",data);
          }
        }); 
}
function init() {
	var system = {
		active: 1,
		delayed: 0,
		mode: 'servo',
		frequency: 50,
		mcf: 16000,
		servo_max: 180,
		servo: 0
	};

	Object.keys(system).forEach(function(name) {
		if (name !== 'active') { // active has to be last
			set(name, system[name]);
		}
	});
	set('active', system['active']);
	servoStream = fs.createWriteStream(path.join(basePath, 'servo'));
}


function turnOn() {
	writeFile (180);
}

function turnOff() {
	writeFile (0);
}

module.exports = {
	init: init,
	turnOn: turnOn,
	turnOff: turnOff 
};