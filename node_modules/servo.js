var fs = require('fs');
var path = require('path');
var basePath = (process.env.TEST ? path.join(__dirname, 'test-pwm0') : '/sys/class/rpi-pwm/pwm0/');
var servoStream;

function set(name, value) {
	value = value + '';
	fs.writeFileSync(path.join(basePath, name), value, { encoding: 'ascii' });
}

function init() {
	var system = {
		active: 1,
		delayed: 0,
		mode: 'servo',
		frequency: 50,
		mcf: 16000,
		servo_max: 32,
		servo: 0
	};

	Object.keys(system).forEach(function(name) {
		if (name !== 'active') { // active has to be last
			set(name, system[name]);
		}
	});
	set('active', system['active']);
	servoStream = fs.createWriteStream(path.join(basePath, 'servo'));
}


function turnOn() {
	servoStream.write(180 + '');
}

function turnOff() {
	servoStream.write(0 + '');
}

module.exports = {
	init: init,
	turnOn: turnOn,
	turnOff: turnOff 
};